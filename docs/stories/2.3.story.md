
# Story: 2.3 - Custom ML Syntax Parsing

**Epic:** 2 - Query Parser Implementation
**Status:** Approved

## Story

As a developer, I want to extend the Query Parser service to handle custom ML syntax, so that users can train and use machine learning models using SQL-like statements.

## Acceptance Criteria

1.  The Query Parser can successfully parse a `CREATE MODEL` statement that follows the BigQuery ML style.
2.  The `CREATE MODEL` statement must support an `OPTIONS` clause to specify `model_type` and `input_label_cols`.
3.  The Query Parser can successfully parse a `ML.PREDICT` function call within a `SELECT` statement.
4.  The parser returns a structured representation (e.g., an AST or a dedicated object) for both `CREATE MODEL` and `ML.PREDICT` statements.
5.  The parser returns a clear error message if the custom ML syntax is invalid.

## Dev Notes

*   **Parsing Strategy:** The existing `sqlparse` library may not be sufficient on its own to handle this custom grammar. A custom parsing solution will be needed. A good approach is to first use `sqlparse` to identify potential custom statements and then use a more powerful parsing library like `lark` or `pyparsing` to handle the specific `CREATE MODEL` and `ML.PREDICT` grammar.
*   **Reference Syntax (BigQuery ML Style):**
    *   **CREATE MODEL:**
        ```sql
        CREATE MODEL my_model
        OPTIONS(model_type='logistic_reg', input_label_cols=['label'])
        AS (
          SELECT feature1, feature2, label
          FROM my_table
        )
        ```
    *   **PREDICT:**
        ```sql
        SELECT *
        FROM ML.PREDICT(MODEL my_model,
          (
            SELECT feature1, feature2
            FROM new_data
          )
        )
        ```
*   **Source:** The decision to use this syntax was based on research into existing "SQL for ML" frameworks and user selection. [Source: User conversation, Research results]
*   **Testing:** Unit tests should cover valid and invalid `CREATE MODEL` and `ML.PREDICT` statements.

## Tasks / Subtasks

*   [x] Research and select a suitable Python parsing library (e.g., `lark`, `pyparsing`) to handle the custom ML grammar.
*   [x] Add the chosen parsing library to the `Pipfile`.
*   [x] Define the grammar for the `CREATE MODEL` statement. (AC: 1, 2)
*   [x] Define the grammar for the `ML.PREDICT` function. (AC: 3)
*   [x] Update the `/parse` route in `main.py` to first attempt standard SQL parsing and, if that fails or a keyword is detected, attempt to parse the custom ML syntax.
*   [x] Implement the parsing logic to generate a structured output for the custom statements. (AC: 4)
*   [x] Implement error handling for invalid custom ML syntax. (AC: 5)
*   [x] Write unit tests for parsing valid `CREATE MODEL` statements.
*   [x] Write unit tests for parsing valid `ML.PREDICT` statements.
*   [x] Write unit tests for parsing invalid custom ML syntax to ensure proper error handling.

## File List

*   `query-parser/Pipfile` (modified)
*   `query-parser/main.py` (modified)
*   `query-parser/tests/test_main.py` (modified)
*   `query-parser/custom_parser.py` (created)
