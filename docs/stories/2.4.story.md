
# Story: 2.4 - Query Validation and Error Handling

**Epic:** 2 - Query Parser Implementation
**Status:** Done

## Story

As a developer, I want the Query Parser service to perform robust validation on incoming queries, so that I can catch errors early and provide clear, actionable feedback to the user.

## Acceptance Criteria

1.  The parser handles keywords in a case-insensitive manner (e.g., `SELECT` is treated the same as `select`).
2.  The parser correctly handles queries with or without a trailing semicolon.
3.  The parser rejects queries that exceed a defined size limit (e.g., 1MB) and returns a specific "Limit" error.
4.  The parser performs semantic validation to ensure SQL clauses are in the correct order (e.g., `SELECT` must come before `FROM`).
5.  The parser identifies and rejects unsupported keywords or symbols, returning a "Syntax" error.
6.  All validation errors stop processing immediately and return a structured JSON error message, as defined in the Dev Notes.

## Dev Notes

*   **Validation Strategy:** The validation logic should be integrated into the `lark` parser and transformer in `custom_parser.py`. Case-insensitivity can be handled directly in the grammar definition. Semantic checks, like clause order, will require adding validation logic to the transformer class.

*   **Query Size Limit:** A configurable size limit should be checked in the `/parse` route in `main.py` before parsing begins. For now, a hardcoded limit of 1MB is acceptable.

*   **Error Message Schema:** All validation errors must conform to the following JSON structure:
    ```json
    {
      "error": {
        "code": "VALIDATION_ERROR",
        "type": "Syntax", // Can be Syntax, Semantic, or Limit
        "message": "An informative error message.",
        "details": {
          "line": 1, // Optional
          "column": 1, // Optional
          "offending_text": "offending_keyword" // Optional
        }
      }
    }
    ```

## Tasks / Subtasks

*   [x] **Case-Insensitivity:** Modify the `lark` grammar in `custom_parser.py` to make keywords case-insensitive. (AC: 1)
*   [x] **Optional Semicolon:** Update the grammar to optionally accept a trailing semicolon. (AC: 2)
*   [x] **Query Size Limit:** In `main.py`, add a check at the beginning of the `/parse` route to reject requests with a body larger than 1MB. (AC: 3)
*   [x] **Semantic Validation:** Enhance the `CustomSqlTransformer` to validate the order of SQL clauses as it builds the AST. (AC: 4)
*   [x] **Error Handling:** Implement a custom exception class for validation errors that contains the necessary information for the structured error response. (AC: 6)
*   [x] **Catch and Format Errors:** Modify the `/parse` route to catch the custom validation exceptions and format the JSON error response according to the schema. (AC: 6)
*   [x] **Unsupported Keywords:** Ensure the `lark` parser is configured to raise an error for any tokens that do not match the defined grammar. (AC: 5)
*   [x] **Unit Tests:**
    *   [x] Write tests for case-insensitive keywords.
    *   [x] Write tests for queries with and without semicolons.
    *   [x] Write a test for a query that exceeds the size limit.
    *   [x] Write tests for incorrect clause order.
    *   [x] Write tests for unsupported keywords.

## File List

*   `query-parser/custom_parser.py` (modified)
*   `query-parser/main.py` (modified)
*   `query-parser/tests/test_main.py` (modified)
